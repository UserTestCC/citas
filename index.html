<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>K-ALMA | Agendamiento de Citas</title>
<meta name="description" content="Agenda de citas para el consultorio K-Alma: selección de psicólogo, fecha, hora, disponibilidad, datos del paciente y modalidad, con estado EN CONSULTA automático." />
<style>
  /* ——— Paleta K-Alma ——— */
  :root{
    --bg:#0f172a;
    --panel:#0b1222;
    --ink:#e6edf3;
    --muted:#9aa4b2;
    --brand:#223D72;     /* azul oscuro */
    --brand2:#2C4E90;    /* azul medio */
    --brandSoft:#D8E2F1; /* azul claro */
    --line:#1f2937;
    --ok:#16a34a;
    --no:#ef4444;
    --warn:#eab308;
    --ring:rgba(44,78,144,.35);
  }

  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;
    font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, Ubuntu, Cantarell, "Noto Sans", sans-serif;
    color:var(--ink);
    background: radial-gradient(1200px 700px at 15% -10%, #0b1222, var(--bg));
    display:grid; place-items:start center; padding:20px;
  }

  .wrap{ width:min(980px,96vw); }

  /* ——— Barra de notificaciones EN CONSULTA ——— */
  .notifybar{
    position:sticky; top:10px; z-index:20;
    display:flex; flex-wrap:wrap; gap:8px; padding:10px;
    background:linear-gradient(180deg,#0d1730 0%, #0b1222 100%);
    border:1px solid #22314a; border-radius:14px; width:min(980px,96vw); margin:0 auto 14px;
    box-shadow:0 12px 30px #0006;
  }
  .notifybar-title{ font-size:13px; color:var(--brandSoft); margin-right:6px; opacity:.9 }
  .pill{
    display:inline-flex; align-items:center; gap:8px;
    font-size:13px; padding:8px 12px; border-radius:999px;
    border:1px solid #2a3b58; background:#0f1930;
    box-shadow:0 2px 0 #0006 inset; white-space:nowrap;
  }
  .pill .dot{ width:10px; height:10px; border-radius:999px; background:var(--no) }
  .pill small{ color:var(--muted); font-size:11px }

  header{
    display:flex; align-items:center; justify-content:space-between;
    margin-bottom:16px;
  }
  .brand{ display:flex; gap:12px; align-items:center; }
  .logo{
    width:44px; height:44px; border-radius:12px;
    background: conic-gradient(from 180deg, var(--brand), var(--brand2), var(--brand));
    border:1px solid #25406e50;
    box-shadow: 0 6px 20px #0b122280 inset, 0 10px 30px #00000040;
  }
  h1{ font-size: clamp(18px, 2.8vw, 26px); margin:0; letter-spacing:.2px; }
  .subtitle{color:var(--muted); font-size:13px}

  .grid{ display:grid; gap:16px; grid-template-columns: 1.2fr .8fr; }
  @media (max-width: 840px){ .grid{grid-template-columns:1fr} }

  .card{
    background: linear-gradient(180deg, #0b1222 0%, #101a2f 100%);
    border:1px solid var(--line);
    border-radius:16px; padding:18px;
    box-shadow: 0 12px 30px #00000055, 0 0 0 1px #ffffff05 inset;
  }
  .card h2{ margin:0 0 12px; font-size:18px; color:var(--brandSoft) }

  label{ display:block; font-size:13px; color:var(--brandSoft); margin-bottom:6px; }
  .row{ display:grid; gap:12px; grid-template-columns: 1fr 1fr }
  @media (max-width: 640px){ .row{grid-template-columns:1fr} }

  select, input[type="text"], input[type="number"], input[type="date"], input[type="time"]{
    width:100%; padding:10px 12px; border-radius:12px; border:1px solid #243044;
    background:#0f1930; color:var(--ink); outline:none;
  }
  select:focus, input:focus{ border-color:var(--brand2); box-shadow: 0 0 0 4px var(--ring); }
  .hint{color:var(--muted); font-size:12px; margin-top:6px}

  .status{
    display:inline-flex; gap:8px; align-items:center;
    font-size:13px; padding:8px 10px; border-radius:999px; border:1px solid #22314a;
    background:#0f1930; margin-top:8px;
  }
  .dot-badge{width:10px; height:10px; border-radius:999px; background:var(--warn); box-shadow:0 0 0 3px #ffffff10}
  .status.ok .dot-badge{background:var(--ok)}
  .status.no .dot-badge{background:var(--no)}

  .actions{ display:flex; gap:10px; flex-wrap:wrap; margin-top:14px }
  button{
    border:1px solid #203455; background:linear-gradient(180deg,#1a2a48 0%, #152540 100%);
    color:var(--ink); border-radius:12px; padding:10px 14px; cursor:pointer; font-weight:600;
  }
  button.primary{ background: linear-gradient(180deg, var(--brand2), var(--brand)); border-color:#3a5aa3; }

  .table{ width:100%; border-collapse:separate; border-spacing:0 10px; margin-top:6px; }
  .table th{ text-align:left; font-size:12px; color:var(--muted); font-weight:600; padding:6px 8px; }
  .table td{ background:#0f1930; border:1px solid #243044; padding:10px 8px; font-size:14px; }
  .table tr td:first-child{border-radius:12px 0 0 12px}
  .table tr td:last-child{border-radius:0 12px 12px 0}

  .empty{
    color:var(--muted); font-size:14px; background:#0f1930; border:1px dashed #2a3b58;
    padding:16px; border-radius:12px; text-align:center;
  }

  .toast{
    position:fixed; right:16px; bottom:16px; background:#0f1930; border:1px solid #2a3b58; color:var(--ink);
    padding:10px 12px; border-radius:12px; box-shadow:0 10px 30px #00000055; display:none;
  }
</style>
</head>
<body>
  <!-- Barra EN CONSULTA automática -->
  <div id="notifybar" class="notifybar" aria-live="polite" style="display:none">
    <span class="notifybar-title">Estado del consultorio:</span>
    <div id="notifyItems" style="display:inline-flex; gap:8px; flex-wrap:wrap"></div>
  </div>

  <div class="wrap">
    <header>
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div>
          <h1>K-ALMA | Agendamiento de Citas</h1>
          <div class="subtitle">Amigos esto es un boceto de prueba.</div>
        </div>
      </div>
    </header>

    <div class="grid">
      <!-- ——— Formulario ——— -->
      <section class="card">
        <h2>Nueva cita</h2>

        <form id="form">
          <div class="row">
            <div>
              <label for="psico">Psicólogo</label>
              <select id="psico" name="psico" required>
                <option value="">— Selecciona —</option>
                <option>Psic Fernando Fierro</option>
                <option>Psic Oscar Garzon</option>
                <option>Psic Jorge Orellana</option>
              </select>
            </div>
            <div>
              <label for="fecha">Fecha</label>
              <input type="date" id="fecha" name="fecha" required />
              <div class="hint">Selecciona el día de la cita.</div>
            </div>
          </div>

          <div class="row">
            <div>
              <label for="hora">Hora</label>
              <input type="time" id="hora" name="hora" step="1800" required />
              <div id="disp" class="status" aria-live="polite"><span class="dot-badge"></span><span>Verifica disponibilidad…</span></div>
              <div class="hint">Intervalos de 30 minutos.</div>
            </div>
            <div>
              <label for="costo">Costo de la cita (USD)</label>
              <input type="number" id="costo" name="costo" min="0" step="0.01" placeholder="Ej: 25.00" required />
              <div class="hint">Ingresa el valor acordado.</div>
            </div>
          </div>

          <div class="row">
            <div>
              <label for="paciente">Nombre del paciente</label>
              <input type="text" id="paciente" name="paciente" placeholder="Nombre y apellido" required />
            </div>
            <div>
              <label for="modalidad">Modalidad</label>
              <select id="modalidad" name="modalidad" required>
                <option value="">— Selecciona —</option>
                <option>presencial</option>
                <option>online</option>
              </select>
              <div class="hint">Opciones: presencial u online.</div>
            </div>
          </div>

          <div class="actions">
            <button type="submit" id="btnGuardar" class="primary">Guardar cita</button>
            <button type="button" id="btnLimpiar">Limpiar formulario</button>
          </div>

          <div class="hint" style="margin-top:8px">
            <strong>Nota:</strong> el estado <em>EN CONSULTA</em> se calcula automáticamente desde la agenda. Duración por defecto: <strong>60 minutos</strong>.
          </div>
        </form>
      </section>

      <!-- ——— Agenda ——— -->
      <section class="card">
        <h2>Agenda (este navegador)</h2>
        <div class="actions" style="margin-bottom:6px">
          <button type="button" id="btnVaciar">Vaciar agenda local</button>
        </div>
        <div id="lista"></div>
      </section>
    </div>
  </div>

  <div id="toast" class="toast" role="status" aria-live="polite"></div>

<script>
(() => {
  // ===== Parámetros del sistema =====
  const GLOBAL_BLOCK = true;        // true: bloqueo global por fecha+hora; false: por psicólogo
  const DEFAULT_DURATION_MIN = 60;  // duración de cada cita para EN CONSULTA
  const TICK_MS = 30 * 1000;        // refresco de la barra EN CONSULTA

  // ===== DOM =====
  const form = document.getElementById('form');
  const psico = document.getElementById('psico');
  const fecha = document.getElementById('fecha');
  const hora  = document.getElementById('hora');
  const paciente = document.getElementById('paciente');
  const costo = document.getElementById('costo');
  const modalidad = document.getElementById('modalidad');
  const disp = document.getElementById('disp');
  const lista = document.getElementById('lista');
  const btnLimpiar = document.getElementById('btnLimpiar');
  const btnVaciar = document.getElementById('btnVaciar');
  const toast = document.getElementById('toast');
  const notifybar    = document.getElementById('notifybar');
  const notifyItems  = document.getElementById('notifyItems');

  // ===== Storage =====
  const LS_KEY = 'k-alma-agenda';

  // ===== Inicialización =====
  const today = new Date(); today.setHours(0,0,0,0);
  fecha.min = toISODate(today);

  renderAgenda();
  renderAutoStatus();
  onCheckAvailability();

  // Ticker para actualizar estado automáticamente
  setInterval(() => renderAutoStatus(), TICK_MS);

  // ===== Eventos =====
  for (const el of [psico, fecha, hora]) {
    el.addEventListener('change', onCheckAvailability);
    el.addEventListener('input', onCheckAvailability);
  }

  form.addEventListener('submit', (e) => {
    e.preventDefault();
    const data = readForm();

    if (!data.psico || !data.fecha || !data.hora || !data.paciente || !data.costo || !data.modalidad) {
      notify('Completa todos los campos obligatorios.', 'warn');
      return;
    }

    if (!isAvailable(data.psico, data.fecha, data.hora)) {
      notify('La hora seleccionada NO está disponible.', 'error');
      return;
    }

    saveCita(data);
    renderAgenda();
    renderAutoStatus(); // actualizar EN CONSULTA si aplica
    notify('Cita guardada exitosamente.');
    form.reset();
    onCheckAvailability();
  });

  btnLimpiar.addEventListener('click', () => {
    form.reset();
    onCheckAvailability();
  });

  btnVaciar.addEventListener('click', () => {
    if (confirm('Esto eliminará TODAS las citas guardadas en este navegador. ¿Continuar?')) {
      localStorage.removeItem(LS_KEY);
      renderAgenda();
      renderAutoStatus();
      notify('Agenda vaciada.');
    }
  });

  // ===== Normalización =====
  function toHHMM(hhmm){
    if (!hhmm) return hhmm;
    const [H,M] = hhmm.split(':').map(Number);
    return `${String(H).padStart(2,'0')}:${String(M||0).padStart(2,'0')}`;
  }
  function normPsico(v){ return String(v||'').trim().toLowerCase(); }
  function normFecha(v){ return String(v||'').trim(); }     // ya viene YYYY-MM-DD
  function normHora(v){ return toHHMM(String(v||'').trim()); }

  // ===== Disponibilidad =====
  function onCheckAvailability(){
    const p = psico.value.trim();
    const f = fecha.value;
    const h = hora.value;
    if (!p || !f || !h) {
      setStatusBadge('pending', 'Verifica disponibilidad…');
      return;
    }
    const ok = isAvailable(p, f, h);
    setStatusBadge(ok ? 'ok' : 'no', ok ? 'Disponible' : 'No disponible');
  }

  function setStatusBadge(type, text){
    disp.classList.remove('ok', 'no');
    disp.querySelector('.dot-badge').style.background = 'var(--warn)';
    if (type === 'ok'){
      disp.classList.add('ok');
      disp.querySelector('.dot-badge').style.background = 'var(--ok)';
    } else if (type === 'no'){
      disp.classList.add('no');
      disp.querySelector('.dot-badge').style.background = 'var(--no)';
    }
    disp.lastElementChild.textContent = text;
  }

  function isAvailable(psicoSel, fechaISO, horaHHMM){
    const P = normPsico(psicoSel);
    const F = normFecha(fechaISO);
    const H = normHora(horaHHMM);

    const all = getAll();
    return !all.some(c => {
      const p = normPsico(c.psico);
      const f = normFecha(c.fecha);
      const h = normHora(c.hora);
      if (GLOBAL_BLOCK){
        // Choque global: si coincide fecha+hora, NO disponible para nadie
        return (f === F && h === H);
      } else {
        // Choque por psicólogo: deben coincidir también el profesional
        return (p === P && f === F && h === H);
      }
    });
  }

  // ===== Persistencia de Citas =====
  function getAll(){
    try{ return JSON.parse(localStorage.getItem(LS_KEY) || '[]'); }catch(_){ return [] }
  }
  function setAll(arr){ localStorage.setItem(LS_KEY, JSON.stringify(arr)); }
  function saveCita(cita){
    const arr = getAll();
    // Guardar ya normalizado
    arr.push({
      id: cryptoRandomId(),
      psico: String(cita.psico).trim(),
      fecha: normFecha(cita.fecha),
      hora:  normHora(cita.hora),
      paciente: String(cita.paciente).trim(),
      costo: String(cita.costo).trim(),
      modalidad: String(cita.modalidad).trim(),
      createdAt: new Date().toISOString()
    });
    // Orden por fecha+hora
    arr.sort((a,b) => (a.fecha+a.hora).localeCompare(b.fecha+b.hora));
    setAll(arr);
  }
  function deleteCita(id){
    const arr = getAll().filter(c => c.id !== id);
    setAll(arr);
    renderAgenda();
    renderAutoStatus();
    notify('Cita eliminada.');
  }
  window.__del = (id) => deleteCita(id);

  // ===== Render tabla =====
  function renderAgenda(){
    const data = getAll();
    if (!data.length){
      lista.innerHTML = `<div class="empty">No hay citas registradas en este navegador.</div>`;
      return;
    }

    const rows = data.map(c => {
      const horaN = normHora(c.hora);
      return `
        <tr>
          <td>${escapeHTML(c.psico)}</td>
          <td>${fmtDateLocal(c.fecha)} ${fmtHora(horaN)}</td>
          <td>${escapeHTML(c.paciente)}</td>
          <td>$ ${Number(c.costo).toFixed(2)}</td>
          <td>${escapeHTML(c.modalidad)}</td>
          <td><button type="button" onclick="window.__del('${c.id}')">Eliminar</button></td>
        </tr>
      `;
    }).join('');

    lista.innerHTML = `
      <table class="table" aria-label="Agenda de citas">
        <thead>
          <tr>
            <th>Psicólogo</th>
            <th>Fecha y hora</th>
            <th>Paciente</th>
            <th>Costo</th>
            <th>Modalidad</th>
            <th></th>
          </tr>
        </thead>
        <tbody>${rows}</tbody>
      </table>
    `;
  }

  // ===== Estado EN CONSULTA automático =====
  function renderAutoStatus(){
    const now = new Date();
    const activeByPsico = getActivePsychologists(now);

    notifyItems.innerHTML = '';
    const names = Object.keys(activeByPsico);
    if (!names.length){
      notifybar.style.display = 'none';
      return;
    }
    notifybar.style.display = 'flex';

    names.forEach(name => {
      const since = activeByPsico[name].since;
      const el = document.createElement('div');
      el.className = 'pill';
      el.innerHTML = `<span class="dot"></span><strong>${escapeHTML(name)}</strong> — EN CONSULTA ${since ? `<small>• ${fmtSince(since)}</small>`:''}`;
      notifyItems.appendChild(el);
    });
  }

  function getActivePsychologists(now){
    const map = {};
    const appts = getAll();
    for (const c of appts){
      const start = parseLocalDateTime(c.fecha, c.hora); // Date local
      if (!start) continue;
      const end = new Date(start.getTime() + DEFAULT_DURATION_MIN*60000);
      if (now >= start && now < end){
        if (!map[c.psico]) map[c.psico] = { since: start };
      }
    }
    return map;
  }

  // ===== Utilitarios =====
  function readForm(){
    return {
      psico: String(psico.value).trim(),
      fecha: normFecha(fecha.value),   // YYYY-MM-DD
      hora:  normHora(hora.value),     // HH:MM
      paciente: String(paciente.value).trim(),
      costo: String(costo.value).trim(),
      modalidad: String(modalidad.value).trim()
    };
  }

  function toISODate(d){
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2,'0');
    const day = String(d.getDate()).padStart(2,'0');
    return `${y}-${m}-${day}`;
  }

  function fmtDateLocal(isoYMD){
    const [y,m,d] = isoYMD.split('-').map(Number);
    const dd = new Date(y, m-1, d);
    return dd.toLocaleDateString('es-EC', {weekday:'short', day:'2-digit', month:'short', year:'numeric'});
  }

  function parseLocalDateTime(isoYMD, hhmm){
    try{
      const [y,m,d] = isoYMD.split('-').map(Number);
      const [H,M]  = hhmm.split(':').map(Number);
      return new Date(y, (m-1), d, H, M, 0, 0); // hora local
    }catch(_){ return null }
  }

  function fmtHora(hhmm){
    try{
      const [H,M] = hhmm.split(':').map(Number);
      const dt = new Date(); dt.setHours(H, M, 0, 0);
      return dt.toLocaleTimeString('es-EC', {hour:'2-digit', minute:'2-digit', hour12:false});
    }catch(_){ return hhmm }
  }

  function fmtSince(dateObj){
    const d = (dateObj instanceof Date) ? dateObj : new Date(dateObj);
    const mins = Math.max(0, Math.round((Date.now() - d.getTime())/60000));
    if (mins < 1) return 'hace instantes';
    if (mins === 1) return 'hace 1 min';
    return `hace ${mins} mins`;
  }

  function escapeHTML(s){
    return String(s).replace(/[&<>"']/g, m => ({
      '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
    }[m]));
  }

  function notify(msg, type='ok'){
    toast.textContent = msg;
    toast.style.display = 'block';
    toast.style.borderColor = type==='error' ? '#5e1d1d' : (type==='warn' ? '#5a4615' : '#2a3b58');
    setTimeout(() => toast.style.display = 'none', 2400);
  }

  function cryptoRandomId(){
    if (window.crypto && crypto.getRandomValues){
      const a = new Uint32Array(2); crypto.getRandomValues(a);
      return [...a].map(n => n.toString(16).padStart(8,'0')).join('');
    }
    return String(Math.random()).slice(2) + Date.now();
  }
})();
</script>
</body>
</html>

